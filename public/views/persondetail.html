{{template "header.html" .}}
<div id="realcontent" class="realcontent">
  {{ $person := (index . "persondetail")}}
  {{ with $person}}

  <!-- Person-Karte -->
  <div class="bg-white shadow rounded-xl p-4 mb-4">
    <p class="text-sm text-gray-500">Person</p>
    <p>{{.Name}}</p>
    <p>{{.Position}}</p>
    <p><a href="mailto:{{.EMail}}">{{.EMail}}</a></p>
    <p><a href="/company/{{.Company.ID}}">Firma: {{.Company.Name}}</a></p>
    {{ range .ContactInfos}}
      <p>{{.Label}}: {{ .Value}}</p>
    {{end}}
  </div>

  <!-- Toolbar: Bearbeiten + Neue Notiz (mit Alpine-Scope) -->
  <div x-data="{ noteOpen: new URLSearchParams(window.location.search).get('addNote') === '1' }">
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <!-- Bearbeiten -->
      <a href="/person/edit/{{.ID}}"
         class="inline-block bg-primary text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
        <i class="fas fa-edit"></i> Bearbeiten
      </a>

      <!-- Neue Notiz -->
      <button
        @click.prevent="noteOpen = !noteOpen; if(noteOpen) $nextTick(() => $refs.noteTitle?.focus())"
        class="inline-block px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
        <i class="fas fa-sticky-note"></i> Neue Notiz
      </button>

      <!-- Fallback ohne JS -->
      <noscript>
        <a href="/notes/new/{{.ID}}" class="inline-block px-4 py-2 bg-white border rounded-button shadow">
          Neue Notiz
        </a>
      </noscript>
    </div>

    <!-- Ausklapp-Formular: Neue Notiz -->
    <div x-show="noteOpen" x-transition x-cloak
         class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">

      <!-- Optional: Server-Flash/Nachricht -->
      {{ with $.flash_note_error }}
        <div class="mb-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md p-2">{{.}}</div>
      {{ end }}

      <form method="POST" action="/notes/create" class="space-y-3">
        {{ with $.CSRFToken }}<input type="hidden" name="csrf" value="{{.}}">{{ end }}
        <input type="hidden" name="parent_id" value="{{.ID}}">
        <input type="hidden" name="parent_type" value="people">

        <div>
          <label for="note_title" class="block text-sm font-medium text-gray-700">Titel</label>
          <input x-ref="noteTitle" id="note_title" name="title" type="text"
                 class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
        </div>

        <div>
          <label for="note_body" class="block text-sm font-medium text-gray-700">Notiz</label>
          <textarea id="note_body" name="body" rows="4" required
                    class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
        </div>

        <div class="flex items-center gap-4">
          <input type="text" name="tags" placeholder="Tags, komma-getrennt"
                 class="flex-1 border rounded-md px-3 py-2">
        </div>

        <div class="flex gap-2">
          <button type="submit"
                  class="bg-primary text-text px-5 py-2 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
            Speichern
          </button>
          <button type="button" @click="noteOpen=false"
                  class="px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
            Abbrechen
          </button>
        </div>
      </form>
    </div>
  </div>
  {{ end }}

<!-- Notizen-Liste -->
{{ with $.notes }}
<div class="bg-white border border-gray-200 rounded-lg divide-y">
  {{ range . }}
  <div class="p-4 relative group" x-data="{ edit: false }">
    {{ $isAuthor := eq $.uid .AuthorID }}

    <!-- Edit-Button nur für Autor -->
    {{ if $isAuthor }}
      <!-- Desktop: auf Hover einblenden -->
      <button
        x-show="!edit"
        @click="edit = true"
        class="hidden sm:inline-flex items-center gap-1 absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50 shadow">
        <i class="fas fa-pen"></i> Bearbeiten
      </button>
      <!-- Mobile: immer sichtbar -->
      <button
        x-show="!edit"
        @click="edit = true"
        class="sm:hidden absolute top-2 right-2 text-xs px-2 py-1 border rounded-md bg-white shadow">
        ✎
      </button>
    {{ end }}

    <!-- Anzeige-Modus -->
    <div x-show="!edit">
      {{ if .Title }}
        <h3 class="font-semibold mb-1">{{ .Title }}</h3>
      {{ else }}
        <h3 class="font-semibold text-gray-700 mb-1">Notiz</h3>
      {{ end }}

      <p class="text-xs text-gray-500 mb-2">
        {{- $t := .EditedAt -}}
        {{- if $t.IsZero -}}
          Aktualisiert: {{ fmtTime .UpdatedAt }}
        {{- else -}}
          Bearbeitet: {{ fmtTime .EditedAt }}
        {{- end -}}
      </p>

      <div class="text-sm text-gray-800">
        {{ nl2br .Body }}
      </div>

      {{ if .Tags }}
      <div class="mt-3 flex flex-wrap gap-2">
        {{ range (splitCSV .Tags) }}
          <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">{{ . }}</span>
        {{ end }}
      </div>
      {{ end }}
    </div>

    <!-- Edit-Modus (Inline-Formular) -->
    {{ if $isAuthor }}
    <div x-show="edit" x-cloak class="mt-2">
      <form method="POST" action="/notes/update/{{ .ID }}" class="space-y-2 bg-gray-50 border rounded-lg p-3">
        {{ with $.CSRFToken }}<input type="hidden" name="csrf" value="{{.}}">{{ end }}

        <div>
          <label class="block text-xs font-medium text-gray-700" for="title_{{ .ID }}">Titel</label>
          <input id="title_{{ .ID }}" name="title" type="text" value="{{ .Title }}"
                 class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-700" for="body_{{ .ID }}">Notiz</label>
          <textarea id="body_{{ .ID }}" name="body" rows="4"
                    class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">{{ .Body }}</textarea>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-700" for="tags_{{ .ID }}">Tags</label>
          <input id="tags_{{ .ID }}" name="tags" type="text" value="{{ .Tags }}"
                 class="mt-1 block w-full border rounded-md px-3 py-2">
        </div>

        <div class="flex gap-2">
          <button type="submit"
                  class="bg-primary text-text px-4 py-2 rounded-button font-bold hover:bg-hover hover:text-white transition-colors text-sm">
            Speichern
          </button>
          <button type="button" @click="edit=false"
                  class="px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50 text-sm">
            Abbrechen
          </button>
        </div>
      </form>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ end }}

{{template "footer.html" .}}