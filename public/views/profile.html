{{template "header.html" .}}
<div class="flex-1 p-8">
  {{template "_flash" .}}

  <!-- Profil -->
  <div class="bg-surface border border-border rounded-card shadow-md p-8 mb-8">
    <h2 class="text-2xl font-bold mb-6">Eigenes Profil</h2>
    <form method="POST" action="/settings/profile" class="space-y-4">
      <input type="hidden" name="csrf" value="{{.CSRFToken}}">
      <div>
        <label for="fullname" class="block text-sm font-medium mb-1">Vollständiger Name</label>
        <input type="text" id="fullname" name="fullname"
               value="{{.user.FullName}}"
               class="bg-white rounded-lg w-full px-4 py-2 border border-border rounded-button focus:ring-2 focus:ring-primary focus:border-transparent">
      </div>
      <button class="bg-primary text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
        Speichern
      </button>
    </form>
  </div>

  <!-- API Tokens -->
  <div class="bg-surface border border-border rounded-card shadow-md p-8">
<h2 class="text-2xl font-bold mb-6">API-Tokens</h2>

{{if .tokens}}
  <table class="w-full text-sm mb-4">
    <thead>
      <tr class="text-left border-b border-border">
        <th class="py-2">Name</th>
        <th class="py-2">Prefix</th>
        <th class="py-2">Status</th>
        <th class="py-2">Erstellt</th>
        <th class="py-2">Zuletzt benutzt</th>
        <th class="py-2">Läuft ab</th>
        <th class="py-2">Aktionen</th>
      </tr>
    </thead>
    <tbody>
      {{range .tokens}}
      <tr class="border-b border-border {{if .Disabled}}opacity-60{{end}}">
        <td class="py-2">{{.Name}}</td>
        <td class="py-2 font-mono">{{.TokenPrefix}}</td>
        <td class="py-2">
          {{/* Status-Badge */}}
          {{if .Disabled}}
            <span class="inline-block px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800">revoked</span>
          {{else if and .ExpiresAt (lt .ExpiresAt.Now) }}
            {{/* Go-Templates können kein .Now; Workaround: unten alternative Variante */}}
          {{else if .ExpiresAt}}
            {{/* aktiv + hat Ablaufdatum */}}
            <span class="inline-block px-2 py-0.5 rounded-full text-xs bg-yellow-100 text-yellow-800">aktiv (läuft ab)</span>
          {{else}}
            <span class="inline-block px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800">aktiv</span>
          {{end}}
        </td>
        <td class="py-2">{{.CreatedAt.Format "02.01.2006 15:04"}}</td>
        <td class="py-2">
          {{if .LastUsedAt}}
            {{.LastUsedAt.Format "02.01.2006 15:04"}}
          {{else}}
            <span class="text-gray-400">—</span>
          {{end}}
        </td>
        <td class="py-2">
          {{if .ExpiresAt}}
            {{.ExpiresAt.Format "02.01.2006 15:04"}}
          {{else}}
            <span class="text-gray-400">—</span>
          {{end}}
        </td>
        <td class="py-2">
          {{if not .Disabled}}
            <form method="POST" action="/settings/tokens/revoke/{{.ID}}" class="inline">
              <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
              <button class="text-red-600 hover:underline">Revoke</button>
            </form>
          {{else}}
            <span class="text-gray-500 text-xs">bereits revoked</span>
          {{end}}
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
{{else}}
  <p class="text-sm text-gray-500 mb-4">Noch keine Tokens erstellt.</p>
{{end}}


    <form method="POST" action="/settings/tokens/create" class="space-y-3">
      <input type="hidden" name="csrf" value="{{.CSRFToken}}">
      <div>
        <label class="block text-sm font-medium mb-1">Name</label>
        <input type="text" name="name" placeholder="z. B. CI-Server"
               class="bg-white rounded-lg w-full px-4 py-2 border border-border focus:ring-2 focus:ring-primary focus:border-transparent">
      </div>
      <button class="bg-primary text-white px-6 py-2 rounded-button font-bold hover:bg-hover transition-colors">
        Neuen Token erstellen
      </button>
    </form>

    {{if .newToken}}
      <div class="mt-4 p-4 border border-green-300 bg-green-50 rounded-lg">
        <p class="font-bold text-green-800">Neuer Token erstellt:</p>
        <p class="font-mono text-green-700 break-all">{{.newToken}}</p>
        <p class="text-sm text-gray-600">Bitte sofort kopieren – der Token wird nicht erneut angezeigt!</p>
      </div>
    {{end}}
  </div>
  <!-- Danger Zone: Account löschen -->
  <div class="bg-white border border-red-300 rounded-card shadow-md p-8 mt-8">
    <h2 class="text-2xl font-bold mb-2 text-red-700">Danger Zone</h2>
    <p class="text-sm text-gray-700 mb-4">
      Das Löschen deines Accounts ist dauerhaft. API-Tokens werden sofort ungültig.
    </p>

    <form method="POST" action="/settings/profile/delete-start" class="space-y-4">
      <input type="hidden" name="csrf" value="{{.CSRFToken}}">
      <label class="block text-sm font-medium">
        Zum Bestätigen tippe <span class="font-mono bg-red-50 px-1 rounded">DELETE</span>:
      </label>
      <input type="text" name="confirm" placeholder="DELETE"
             class="bg-white rounded-lg w-full px-4 py-2 border border-red-300 focus:ring-2 focus:ring-red-500 focus:border-transparent">

      <button class="bg-red-600 text-white px-6 py-3 rounded-button font-bold hover:bg-red-700 transition-colors">
        Weiter zur Bestätigung
      </button>
    </form>
  </div>

</div>
{{template "footer.html" .}}
