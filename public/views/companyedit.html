{{template "header.html" .}}
{{$company := (index . "company") }}
<form action='{{index . "action"}}' method="post">
  <input type="hidden" name="csrf" value="{{ .CSRFToken }}">

  <fieldset class="mt-3 p-3 border rounded grid grid-cols-4 gap-2">
    <legend>Kundendaten</legend>
    <div class="w-full col-span-4">
      <label for="companyname">Firmenname {{ template "help-link" "customerdata/#allgemeine-informationen"}}</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="name" id="companyname" placeholder="Muster GmbH" value="{{$company.Name}}">
    </div>
    <div class="col-span-4">
      <label for="background">Zusatzinformation</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="background" name="background" placeholder="z.B. Branche" value="{{$company.Background}}">
    </div>
    <div class="col-span-4">
      <label for="address">Adresse</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="address1" id="address" placeholder="Hauptstraße 12" value="{{$company.Address1}}">
    </div>
    <div class="col-span-4">
      <label for="address2">Zusatz <span class="text-muted">(Optional)</span></label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="address2" id="address2" placeholder="3. Hinterhof" value="{{$company.Address2}}">
    </div>
    <div class="mb-2">
      <label for="zip">PLZ</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="zip" name="zip" placeholder="12345" value="{{$company.Zip}}">
    </div>
    <div class="mb-2 col-span-2">
      <label for="city">Ort</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="city" name="city" placeholder="Berlin" value="{{$company.City}}">
    </div>
    <div class="col-span-1">
      <label for="country">Land</label>
      <input class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        list="countryOptions" id="country" name="country" placeholder="Tippen für Suche..." value="{{$company.Country}}"
        autocomplete="off">
      <datalist id="countryOptions">
        <option value="Deutschland">
        <option value="Schweiz">
        <option value="Niederlande">
        <option value="Frankreich">
        <option value="Österreich">
        <option value="Polen">
      </datalist>
    </div>
  </fieldset>

  <fieldset class="mt-3 p-3 border rounded grid sm:grid-cols-4 gap-2">
    <legend>Rechnungsdaten</legend>
    <div class="sm:col-span-4">
      <label for="emailinvoice">E-Mail für Rechnungen</label>
      <input type="email" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="emailinvoice" id="emailinvoice" placeholder="info@example.com" value="{{$company.InvoiceEmail}}">
    </div>
    <div class="sm:col-span-4">
      <label for="contactinvoice">Ansprechpartner für Rechnungen</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="contactinvoice" id="contactinvoice" placeholder="Max Mustermann" value="{{$company.ContactInvoice}}">
    </div>
   <div x-data="customerNumChecker({ initial: '{{.company.CustomerNumber}}',  exclude: '{{.company.ID}}' })"
      x-init="checkNow()">
      <label class="form-label" for="customer_number">Kundennummer</label>
      <div class="relative">
        <input id="customer_number" name="customer_number" type="text"
          class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5 pr-9"
          x-model.trim="value" @input.debounce.400ms="checkNow()" autocomplete="off" placeholder="{{.company.CustomerNumber}}">
        <input type="hidden" name="company_id" value="{{.company.ID}}">

        <!-- Status-icon right -->
        <div class="absolute inset-y-0 right-2 flex items-center pointer-events-none">
          <template x-if="state === 'checking'">
            <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" opacity=".2" />
              <path d="M12 2a10 10 0 0 1 10 10" fill="none" stroke="currentColor" stroke-width="2" />
            </svg>
          </template>
          <template x-if="state === 'ok'">
            <span class="text-green-600">✓</span>
          </template>
          <template x-if="state === 'taken'">
            <span class="text-red-600">●</span>
          </template>
        </div>
      </div>

      <p class="text-xs mt-1" :class="{
       'text-gray-500': state==='idle' || state==='checking',
       'text-green-700': state==='ok',
       'text-red-700': state==='taken',
       'text-orange-700': state==='error'
     }" x-text="message"></p>
    </div>

    <script>
      function customerNumChecker({ initial = '', exclude = '' } = {}) {
        return {
          value: initial || '',
          exclude: exclude || '',
          state: 'idle',   // idle | checking | ok | taken | error
          message: '',
          lastQuery: '',
          async checkNow() {
            // empty -> neutral
            if (!this.value) {
              this.state = 'idle';
              this.message = 'Vorschlag – kann überschrieben werden.';
              return;
            }
            const q = this.value;
            this.lastQuery = q;
            this.state = 'checking';
            this.message = 'Prüfe Verfügbarkeit…';

            const qs = new URLSearchParams({ num: q });
            if (this.exclude) qs.set('exclude', this.exclude);

            try {
              const res = await fetch(`/api/customer-number/check?${qs.toString()}`, {
                headers: { 'Accept': 'application/json' }, cache: 'no-store'
              });
              const data = await res.json();
              if (this.lastQuery !== q) return;
              if (data.ok) { this.state = 'ok'; this.message = 'Verfügbar'; }
              else { this.state = 'taken'; this.message = data.message || 'Bereits vergeben'; }
            } catch {
              if (this.lastQuery !== q) return;
              this.state = 'error'; this.message = 'Fehler bei der Prüfung';
            }
          }
        };
      }
    </script>
    <div>
      <label for="lieferantennummer">Lieferantennummer</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="lieferantennummer" name="suppliernumber" placeholder="12345" value="{{$company.SupplierNumber}}">
    </div>
    <div class="col-md-3">
      <label for="invoicecurrency">Währung (EUR, ...)</label>
      <input list="currency" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="invoicecurrency" name="invoicecurrency" value="{{$company.InvoiceCurrency}}">
    </div>

    <div>
      <label for="umsatzsteuerid">USt. ID</label>
      <input type="text" name="vatid"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5" id="umsatzsteuerid"
        placeholder="DE12345678" value="{{$company.VATID}}">
    </div>
    <div>
      <label for="taxtype">Steuerart</label>
      <div class="relative">
        <select name="invoicetaxtype" id="taxtype"
          class="w-full bg-white placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded-lg pl-3 pr-8 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-400 shadow-sm focus:shadow-md appearance-none cursor-pointer">
          <option value="S" {{if eq $company.InvoiceTaxType "S" }}selected{{end}}>Umsatzsteuerpflichtige Umsätze
          </option>
          <option value="G" {{if eq $company.InvoiceTaxType "G" }}selected{{end}}>Ausfuhrlieferung (Außerhalb EU)
          </option>
          <option value="K" {{if eq $company.InvoiceTaxType "K" }}selected{{end}}>Innergemeinschaftliche Lieferungen
            (Innerhalb EU)</option>
          <option value="E" {{if eq $company.InvoiceTaxType "E" }}selected{{end}}>Steuerfreie Umsätze §4 UStG
          </option>
          <option value="AE" {{if eq $company.InvoiceTaxType "AE" }}selected{{end}}>Reverse Charge</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.2" stroke="currentColor"
          class="h-5 w-5 ml-1 absolute top-2.5 right-2.5 text-slate-700">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
        </svg>
      </div>

    </div>
    <div class="sm:col-span-1">
      <label for="defaulttaxrate">Standardsteuersatz</label>
      <input type="text" name="defaulttaxrate" id="defaulttaxrate"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        value="{{$company.DefaultTaxRate}}">
    </div>
    <div class="sm:col-span-2">
      <label for="exemptionreason">Grund bei Steuerbefreiung</label>
      <input type="text" name="invoiceexemptionreason" id="exemptionreason"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        value="{{$company.InvoiceExemptionReason}}">
    </div>
    <div class="sm:col-span-4">
      <label for="invoiceopening">Anrede</label>
      <textarea name="invoiceopening" id="invoiceopening"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        style="height: 80px;">{{$company.InvoiceOpening}}</textarea>
    </div>
    <div class="sm:col-span-4">
      <label for="invoicefooter">Fußzeile</label>
      <textarea name="invoicefooter" id="invoicefooter"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        style="height: 80px;">{{$company.InvoiceFooter}}</textarea>
    </div>
  </fieldset>

<fieldset class="border rounded p-3 mt-3" x-data="{ counter: 1, showDivs: [] }">
  <legend>Kontaktdaten</legend>

  <!-- bestehende Einträge -->
  {{ range $i, $p := $company.ContactInfos }}
  <div id="contactedit{{$i}}" class="grid grid-cols-6 gap-2 items-start" data-pos="{{$i}}">
    <!-- Type -->
    <div>
      <label class="block text-xs mb-1" for="contact{{$i}}type">Typ</label>
      <select id="contact{{$i}}type" name="phone[{{$i}}].type"
              class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5">
        {{ $t := $p.Type }}
        <option value="phone"   {{ if eq $t "phone" }}selected{{ end }}>Telefon</option>
        <option value="fax"     {{ if eq $t "fax" }}selected{{ end }}>Fax</option>
        <option value="email"   {{ if eq $t "email" }}selected{{ end }}>E-Mail</option>
        <option value="website" {{ if eq $t "website" }}selected{{ end }}>Website</option>
        <option value="linkedin"{{ if eq $t "linkedin" }}selected{{ end }}>LinkedIn</option>
        <option value="twitter" {{ if eq $t "twitter" }}selected{{ end }}>Twitter</option>
        <option value="github"  {{ if eq $t "github" }}selected{{ end }}>GitHub</option>
        <option value="other"   {{ if eq $t "other" }}selected{{ end }}>Sonstiges</option>
      </select>
    </div>

    <!-- Label -->
    <div class="col-span-2">
      <label class="block text-xs mb-1" for="contact{{$i}}label">Bezeichnung</label>
      <input id="contact{{$i}}label" list="locationlist" name="phone[{{$i}}].label"
             class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
             value="{{$p.Label}}">
    </div>

    <!-- Value -->
    <div class="col-span-2">
      <label class="block text-xs mb-1" for="contact{{$i}}value">Angabe</label>
      <input id="contact{{$i}}value" type="text" name="phone[{{$i}}].value"
             class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
             value="{{$p.Value}}">
    </div>

    <!-- Remove -->
    <div class="pt-6">
      <button class="btn" type="button"
              onclick="document.getElementById('contactedit{{$i}}').remove();">
        <img src="/static/images/trash.svg" alt="Löschen">
      </button>
    </div>
  </div>
  {{ end }}

  {{ $l := len $company.ContactInfos }}

  <template x-for="(div, index) in showDivs" :key="div.id">
    <div class="grid grid-cols-6 gap-2 mt-2 items-start">
      <!-- Type -->
      <div>
        <label class="block text-xs mb-1" :for="'contact' + (index + {{ $l }}) + 'type'">Typ</label>
        <select :id="'contact' + (index + {{ $l }}) + 'type'"
                :name="'phone[' + (index + {{ $l }}) + '].type'"
                class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5">
          <option value="phone">Telefon</option>
          <option value="fax">Fax</option>
          <option value="email">E-Mail</option>
          <option value="website">Website</option>
          <option value="linkedin">LinkedIn</option>
          <option value="twitter">Twitter</option>
          <option value="github">GitHub</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>

      <!-- Label -->
      <div class="col-span-2">
        <label class="block text-xs mb-1" :for="'contact' + (index + {{ $l }}) + 'label'">Bezeichnung</label>
        <input :id="'contact' + (index + {{ $l }}) + 'label'" list="locationlist"
               :name="'phone[' + (index + {{ $l }}) + '].label'"
               class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5">
      </div>

      <!-- Value -->
      <div class="col-span-2">
        <label class="block text-xs mb-1" :for="'contact' + (index + {{ $l }}) + 'value'">Angabe</label>
        <input :id="'contact' + (index + {{ $l }}) + 'value'" type="text"
               :name="'phone[' + (index + {{ $l }}) + '].value'"
               class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5">
      </div>

      <!-- Remove -->
      <div class="pt-6">
        <button class="btn" type="button" @click="showDivs.splice(index, 1)">
          <img src="/static/images/trash.svg" alt="Löschen">
        </button>
      </div>
    </div>
  </template>

  <!-- Button -->
  <div class="mt-3">
    <button @click="showDivs.push({ id: counter, type: 'phone', label: '', value: '' }); counter++"
            class="bg-primary-light text-text rounded-button font-bold hover:bg-hover hover:text-white transition-colors"
            type="button">
      Zeile hinzufügen
    </button>
  </div>
</fieldset>



  <button
    class="bg-primary text-text mt-4 px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors"
    type="submit">{{index . "submit"}}</button>
  <a href='{{index . "cancel"}}'>
    <button type="button"
      class="bg-accent-green text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
      Abbruch
    </button></a>

  <datalist id="currency">
    <option>EUR</option>
    <option>CHF</option>
  </datalist>
  <datalist id="locationlist">
    <option value="Arbeit"></option>
    <option value="Büro"></option>
    <option value="Durchwahl"></option>
    <option value="Fax"></option>
    <option value="Mobil"></option>
    <option value="Privat"></option>
    <option value="Support"></option>
    <option value="Zentrale"></option>
  </datalist>
</form>



{{template "footer.html" .}}