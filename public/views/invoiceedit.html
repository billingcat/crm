{{template "header.html" .}}
{{$company := (index . "company") }}
{{$invoice := (index . "invoice") }}

<form class="needs-validation" action='{{index . "action"}}' method="post">
  <input type="hidden" name="companyid" value="{{$company.ID}}">
  <input type="hidden" name="invoiceid" value="{{$invoice.ID}}">
  <input type="hidden" id="defaultTaxRate" name="defaultTaxRate" value="{{$company.DefaultTaxRate}}">
  <input type="hidden" name="csrf" value="{{.CSRFToken}}">

  <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-4">
    <div>
      <label for="date">Datum {{ template "help-link" "invoices/#allgemeine-angaben"}}</label>
      <input type="date" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="date" name="date" value="{{$invoice.Date | htmldate}}">
    </div>
    <div>
      <label for="leistungsdatum">Leistungsdatum</label>
      <input type="date" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="leistungsdatum" name="occurrencedate" value="{{$invoice.OccurrenceDate | htmldate}}">
    </div>
    <div>
      <label for="duedate">Fälligkeitsdatum</label>
      <input type="date" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="duedate" name="duedate" value="{{$invoice.DueDate | htmldate}}">
    </div>
    <div>
      <label for="invoicenumber">Rechnungsnummer</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="invoicenumber" name="invoicenumber" value="{{$invoice.Number}}">
    </div>
    <div>
      <label for="ordernumber">Bestellnummer, Auftragsnummer</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="ordernumber" name="ordernumber" value="{{$invoice.OrderNumber}}">
    </div>
    <div>
      <label for="buyerreference">Käuferreferenz, Leitweg-ID</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="buyerreference" name="buyerreference" value="{{$invoice.BuyerReference}}">
    </div>
    <div>
      <label for="suppliernumber">Lieferantennummer</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="suppliernumber" name="suppliernumber" value="{{$invoice.SupplierNumber}}">
    </div>
    <div>
      <label for="counter">Int. Zähler</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="counter" name="counter" value="{{$invoice.Counter}}">
    </div>

    <div>
      <label for="letterhead">Briefkopf</label>
      <div class="relative">
        <select id="letterhead" name="letterhead_template_id" class="selectbox">
          {{- $sel := (index . "selectedTemplateID") -}}
          <option value="" {{ if not $sel }}selected{{ end }}>Automatisch</option>
          {{- range (index . "letterheads") }}
          <option value="{{ .ID }}" {{ if and $sel (eq (printf "%d" .ID) $sel) }}selected{{ end }}>
            {{ .Name }}
          </option>
          {{- end }}
        </select>
        <svg class="h-5 w-5 ml-1 absolute top-2.5 right-2.5 text-slate-700">
          <use href="#updownsvg" />
        </svg>
      </div>
      <p class="mt-1 text-xs text-slate-500">
        „Automatisch“ nutzt <code>layout.xml</code> falls vorhanden, sonst die voreingestellte Layoutdatei.
      </p>
    </div>


    <div class="lg:col-span-6">
      <label for="contactinvoice">Rechnung Ansprechpartner</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="contactinvoice" name="contactinvoice" placeholder="Max Mustermann" value="{{$invoice.ContactInvoice}}">
    </div>
    <div class="lg:col-span-6">
      <label for="anrede">Anrede</label>
      <textarea id="anrede" name="anrede"
        class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        placeholder="Sehr geehrter Herr Meyer,&#x0a;&#x0a;wir bedanken uns ..."
        style="height: 100px;">{{ $invoice.Opening}}</textarea>
    </div>
    <div class="lg:col-span-6">
      <label for="fusszeile">Fußzeile</label>
      <textarea class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        id="fusszeile" name="fusszeile" placeholder="Bitte zahlen Sie den Gesamtbetrag auf unten stehendes Konto."
        style="height: 80px;">{{$invoice.Footer}}</textarea>
    </div>
    <div class="lg:col-span-2">
      <label for="taxtype">Steuer</label>
      <div class="relative">
        <select id="taxtype" name="taxtype" class="selectbox">
          <option value="S" {{if eq $invoice.TaxType "S" }}selected{{end}}>Umsatzsteuerpflichtige Umsätze
          </option>
          <option value="G" {{if eq $invoice.TaxType "G" }}selected{{end}}>Ausfuhrlieferung (Außerhalb EU)
          </option>
          <option value="K" {{if eq $invoice.TaxType "K" }}selected{{end}}>Innergemeinschaftliche Lieferungen
            (Innerhalb EU)</option>
          <option value="E" {{if eq $invoice.TaxType "E" }}selected{{end}}>Steuerfreie Umsätze §4 UStG</option>
          <option value="AE" {{if eq $invoice.TaxType "AE" }}selected{{end}}>Reverse Charge</option>
        </select>
        <svg class="h-5 w-5 ml-1 absolute top-2.5 right-2.5 text-slate-700">
          <use href="#updownsvg" />
        </svg>
      </div>
    </div>
    <div>
      <label for="ustid">USt-ID</label>
      <input type="text" class="bg-white border border-gray-300 text-sm rounded-lg focus:ring-primary w-full p-2.5"
        name="ustid" id="ustid" value="{{$company.VATID}}">
    </div>
    <div>
      <label for="currency">Währung</label>
      <div class="relative">
        <select name="currency" id="currency" class="selectbox">
          <option value="EUR" {{if eq $company.InvoiceCurrency "EUR" }}selected{{end}}>EUR</option>
          <option value="CHF" {{if eq $company.InvoiceCurrency "CHF" }}selected{{end}}>CHF</option>
        </select>
        <svg class="h-5 w-5 ml-1 absolute top-2.5 right-2.5 text-slate-700">
          <use href="#updownsvg" />
        </svg>
      </div>
    </div>
    <div class="lg:col-span-6">
      <label for="exemptionreason">Grund bei Steuerbefreiung</label>
      <input type="text" name="invoiceexemptionreason" id="exemptionreason"
        class="bg-white border border-gray-300 text-sm rounded-lg  w-full focus:ring-primary p-2.5"
        value="{{$company.InvoiceExemptionReason}}">
    </div>
  </div>

  <!-- Positions: Alpine state + sortable container -->
  <div x-data="{ counter: 1, showDivs: [], defaultTax: Number(document.getElementById('defaultTaxRate')?.value || 0) }">
    <div id="positions">
      {{range $pos, $ignore := $invoice.InvoicePositions}}
      <fieldset id="fieldset{{$pos}}" data-pos="{{$pos}}" class="mt-3 p-3 border rounded invoicepos">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
          <div>
            <label for="id{{$pos}}">Pos.</label>
            <input id="id{{$pos}}" type="text"
              class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" name="is{{$pos}}"
              value="{{.Position}}" readonly>
          </div>
          <div class="lg:col-span-2">
            <label for="einheit{{$pos}}">Einheit</label>
            <div class="relative">
              <select class="selectbox-sm" id="einheit{{$pos}}" name="invoicepos[{{$pos}}].einheit">
                <option value="C62" {{if eq .UnitCode "C62" }}selected{{end}}>Stück</option>
                <option value="LS" {{if eq .UnitCode "LS" }}selected{{end}}>pauschal</option>
                <option value="HUR" {{if eq .UnitCode "HUR" }}selected{{end}}>Stunden</option>
                <option value="DAY" {{if eq .UnitCode "DAY" }}selected{{end}}>Tage</option>
                <option value="WEE" {{if eq .UnitCode "WEE" }}selected{{end}}>Wochen</option>
                <option value="MON" {{if eq .UnitCode "MON" }}selected{{end}}>Monate</option>
              </select>
              <svg class="h-5 w-5 ml-1 absolute top-1.5 right-2.5 text-slate-700">
                <use href="#updownsvg" />
              </svg>
            </div>
          </div>
          <div>
            <label for="menge{{$pos}}">Menge</label>
            <input id="menge{{$pos}}"
              class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
              name="invoicepos[{{$pos}}].menge" onchange="updatefields('{{$pos}}')" value="{{.Quantity}}">
          </div>
          <div class="lg:col-span-3">
            <label for="einzelpreis{{$pos}}">Einzelpreis (netto)</label>
            <input id="einzelpreis{{$pos}}"
              class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
              name="invoicepos[{{$pos}}].einzelpreis" onchange="updatefields('{{$pos}}')" value="{{.NetPrice}}">
          </div>
          <div>
            <label for="steuersatz{{$pos}}">Steuer</label>
            <input id="steuersatz{{$pos}}"
              class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" list="steuersätze"
              name="invoicepos[{{$pos}}].steuersatz" onchange="updatefields('{{$pos}}')" value="{{.TaxRate}}">
          </div>
          <div class="lg:col-span-3">
            <label for="total{{$pos}}">Gesamt (netto)</label>
            <input id="total{{$pos}}"
              class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
              name="invoicepos[{{$pos}}].gesamtpreis" value="{{.LineTotal}}" readonly>
          </div>
          <div class="lg:col-span-12 grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-2 items-start">
            <div>
              <label for="text{{$pos}}">Beschreibung</label>
              <input id="text{{$pos}}"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
                name="invoicepos[{{$pos}}].leistungstext" value="{{.Text}}">
            </div>
            <div class="flex items-center justify-end gap-2 flex-nowrap lg:translate-y-[30px]">
              <button type="button" class="drag-handle btn w-5 h-5 p-0" aria-label="Ziehen zum Verschieben">↕</button>
              <button type="button"
                class="btn inline-flex items-center justify-center w-5 h-5 p-0 shrink-0 rounded hover:bg-slate-100"
                onclick="removePosition(this)">
                <img src="/static/images/trash.svg" alt="Löschen" class="w-5 h-5 shrink-0" />
              </button>
              <button type="button"
                class="btn inline-flex items-center justify-center w-5 h-5 shrink-0 rounded hover:bg-slate-100"
                @click="duplicatePosition(Number($el.closest('fieldset').dataset.pos))">
                <img src="/static/images/duplicate.svg" alt="Duplizieren" class="w-5 h-5 shrink-0" />
              </button>
              <button type="button" class="btn w-5 h-5 p-0" onclick="moveUp(this)">▲</button>
              <button type="button" class="btn w-5 h-5 p-0" onclick="moveDown(this)">▼</button>
            </div>
          </div>
        </div>
      </fieldset>
      {{end}}

      {{ $l := len $invoice.InvoicePositions }}
      <template x-for="(div, index) in showDivs" :key="div.id">
        <fieldset :id="'fieldset' + (index + {{ $l}})" :data-pos="index + {{ $l}}"
          class="mt-3 p-3 border rounded invoicepos">
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-2">
            <div>
              <label :for="'id' + (index + {{ $l}})">Pos.</label>
              <input :id="'id' + (index + {{ $l}})" type="text"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1"
                :name="'is' + (index + {{ $l}})" :value="( index + 1 +  {{ $l }} )" readonly>
            </div>
            <div class="lg:col-span-2">
              <label :for="'einheit' + (index + {{ $l}})">Einheit</label>
              <div class="relative">
                <select class="selectbox-sm" :id="'einheit' + (index + {{ $l }})"
                  :name="'invoicepos[' + ( index + {{ $l }} ) + '].einheit'">
                  <option value="C62" selected>Stück</option>
                  <option value="LS">pauschal</option>
                  <option value="HUR">Stunden</option>
                  <option value="DAY">Tage</option>
                  <option value="WEE">Wochen</option>
                  <option value="MON">Monate</option>
                </select>
                <svg class="h-5 w-5 ml-1 absolute top-1.5 right-2.5 text-slate-700">
                  <use href="#updownsvg" />
                </svg>
              </div>
            </div>
            <div>
              <label :for="'menge' + (index + {{ $l }})">Menge</label>
              <input :id="'menge' + (index + {{ $l }})"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
                :name="'invoicepos[' + ( index + {{$l}} ) + '].menge'"
                :onchange="'updatefields(' +  ( {{ $l }} + index) + ')'" value="">
            </div>
            <div class="lg:col-span-3">
              <label :for="'einzelpreis' + (index + {{ $l }})">Einzelpreis (netto)</label>
              <input :id="'einzelpreis' + (index + {{ $l }})"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
                :name="'invoicepos[' + ( index + {{ $l }} ) + '].einzelpreis'"
                :onchange="'updatefields(' +  ( {{ $l }} + index) + ')'" value="">
            </div>
            <div>
              <label :for="'steuersatz' + (index + {{ $l }})">Steuer</label>
              <input :id="'steuersatz' + (index + {{ $l }})"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" list="steuersätze"
                :name="'invoicepos[' + ( index + {{$l}} ) + '].steuersatz'"
                :onchange="'updatefields(' +  ( {{ $l }} + index) + ')'" :value="defaultTax">
            </div>
            <div class="lg:col-span-3">
              <label :for="'total' + (index + {{ $l }})">Gesamt (netto)</label>
              <input :id="'total' + (index + {{ $l }})"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
                :name="'invoicepos[' + ( index + {{ $l }} ) + '].gesamtpreis'" value="0" readonly>
            </div>
            <div class="lg:col-span-11">
              <label :for="'text' + (index + {{ $l }})">Beschreibung</label>
              <input :id="'text' + (index + {{ $l }})"
                class="bg-white border border-gray-300 text-sm rounded focus:ring-primary w-full p-1" type="text"
                :name="'invoicepos[' + ( index + {{ $l }} ) + '].leistungstext'" value="">
            </div>

            <div class="flex items-center space-x-2 lg:relative lg:top-3">
              <button type="button" class="drag-handle btn" aria-label="Ziehen zum Verschieben">↕</button>

              <button type="button" class="btn"
                @click="$el.closest('fieldset').remove(); renumberPositions(); updatetotals();">
                <img src="/static/images/trash.svg" width="20" alt="Löschen">
              </button>

              <button type="button" class="btn" @click="duplicatePosition(Number($el.closest('fieldset').dataset.pos))">
                <img src="/static/images/duplicate.svg" width="20" alt="Duplizieren">
              </button>

              <button type="button" class="btn" onclick="moveUp(this)">▲</button>
              <button type="button" class="btn" onclick="moveDown(this)">▼</button>
            </div>
          </div>
        </fieldset>
      </template>
    </div>

    <div id="addposition" class="mt-3 flex gap-2">
      <button @click="showDivs.push({ id: counter }); counter++"
        class="bg-primary-light text-text  rounded-button font-bold hover:bg-hover hover:text-white transition-colors"
        type="button">Zeile hinzufügen</button>

      <!-- Import -->
      <input id="import-file" type="file" accept=".json,.csv,.xml" class="hidden">
      <button type="button"
        class="bg-primary-light text-text rounded-button font-bold hover:bg-hover hover:text-white transition-colors"
        onclick="document.getElementById('import-file').click()">
        Importieren
      </button>
    </div>
    <div id="import-errors" class="text-red-700 text-sm mt-2"></div>
  </div>

  <div class="bg-white shadow rounded-xl p-4 mt-4 mb-4">
    <p class="text-sm text-gray-500">Zusammenfassung</p>
    <table>
      <tr id="netsumrow">
        <td>Summe (netto)</td>
        <td class="text-end" id="netsum"></td>
      </tr>
      <tr>
        <td>Gesamtbetrag</td>
        <td class="text-end" id="gross"></td>
      </tr>
    </table>
  </div>

  <button class="bg-primary text-text rounded-button font-bold hover:bg-hover hover:text-white transition-colors"
    type="submit" onclick="updateAllFields()">
    {{ index . "submit" }}
  </button>

  <a class="btn btn-danger" href='{{ index . "cancel" }}'>
    <button type="button"
      class="bg-primary-light text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
      Abbruch
    </button>
  </a>

  <a href="https://docs.billingcat.de/de/docs/invoices/" target="_blank" rel="noopener">
    <button type="button"
      class="bg-primary-light text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
      Hilfe
    </button>
  </a>
</form>

<!-- SortableJS (drag & drop) -->
<script src="/static/js/Sortable.min.js"></script>

<script>
  // Next free index (used for duplication)
  function getNextPos() {
    let max = -1;
    document.querySelectorAll('fieldset.invoicepos').forEach(fs => {
      const n = Number(fs.dataset.pos);
      if (Number.isFinite(n) && n > max) max = n;
    });
    return max + 1;
  }

  // Remove via button
  function removePosition(btn) {
    const fs = btn.closest('fieldset.invoicepos');
    if (fs) {
      fs.remove();
      renumberPositions();
      updatetotals();
    }
  }

  // after structural changes: renumber all indices consistently
  function renumberPositions() {
    const fieldsets = Array.from(document.querySelectorAll('#positions fieldset.invoicepos'));
    fieldsets.forEach((fs, newPos) => {
      const oldPos = Number(fs.dataset.pos);
      if (oldPos === newPos) {
        // update visible position
        const posInputSame = fs.querySelector(`input[name="is${newPos}"]`);
        if (posInputSame) posInputSame.value = String(newPos + 1);
        return;
      }

      const rewrite = s => {
        if (!s) return s;
        return s
          .replaceAll(`[${oldPos}]`, `[${newPos}]`)
          .replaceAll(`(${oldPos})`, `(${newPos})`)
          .replaceAll(`fieldset${oldPos}`, `fieldset${newPos}`)
          .replace(new RegExp(`\\b(einheit|menge|einzelpreis|steuersatz|total|text|is|id)${oldPos}\\b`, 'g'),
            (_, pref) => `${pref}${newPos}`);
      };

      fs.id = `fieldset${newPos}`;
      fs.dataset.pos = String(newPos);

      fs.querySelectorAll('[id],[for],[name],[list],[onclick],[onchange]').forEach(el => {
        for (const attr of ['id', 'for', 'name', 'list', 'onclick', 'onchange']) {
          if (el.hasAttribute(attr)) {
            const v = el.getAttribute(attr);
            const r = rewrite(v);
            if (r !== v) el.setAttribute(attr, r);
          }
        }
      });

      const posInput = fs.querySelector(`input[name="is${newPos}"]`);
      if (posInput) posInput.value = String(newPos + 1);
    });

    updatetotals();
  }

  // arrow fallback
  function moveUp(btn) {
    const fs = btn.closest('fieldset.invoicepos');
    const prev = fs?.previousElementSibling;
    if (fs && prev && prev.matches('fieldset.invoicepos')) {
      prev.insertAdjacentElement('beforebegin', fs);
      renumberPositions();
    }
  }
  function moveDown(btn) {
    const fs = btn.closest('fieldset.invoicepos');
    const next = fs?.nextElementSibling;
    if (fs && next && next.matches('fieldset.invoicepos')) {
      next.insertAdjacentElement('afterend', fs);
      renumberPositions();
    }
  }

  // duplicate
  function duplicatePosition(pos) {
    pos = Number(pos);
    const original = document.getElementById('fieldset' + pos);
    if (!original) return;

    const newPos = getNextPos();
    const clone = original.cloneNode(true);

    // Rewrite to the new position number
    const rewrite = (s) => {
      if (!s) return s;
      return s
        .replaceAll(`[${pos}]`, `[${newPos}]`)
        .replaceAll(`(${pos})`, `(${newPos})`)
        .replaceAll(`fieldset${pos}`, `fieldset${newPos}`)
        .replace(new RegExp(`\\b(einheit|menge|einzelpreis|steuersatz|total|text|is|id)${pos}\\b`, 'g'),
          (_, pref) => `${pref}${newPos}`);
    };
    clone.id = 'fieldset' + newPos;
    clone.dataset.pos = String(newPos);

    clone.querySelectorAll('[id],[for],[name],[list],[onclick],[onchange]').forEach(el => {
      for (const attr of ['id', 'for', 'name', 'list', 'onclick', 'onchange']) {
        if (el.hasAttribute(attr)) {
          const v = el.getAttribute(attr);
          const r = rewrite(v);
          if (r !== v) el.setAttribute(attr, r);
        }
      }
    });

    // visible position number reset to next (will be renumbered later)
    const posInput = clone.querySelector(`input[name="is${newPos}"]`);
    if (posInput) posInput.value = String(document.querySelectorAll('fieldset.invoicepos').length + 1);

    original.insertAdjacentElement('afterend', clone);

    // Consolidate and refresh totals
    renumberPositions();
    calculatesum(newPos);
  }

  // update all fields
  function updateAllFields() {
    document.querySelectorAll('fieldset.invoicepos').forEach(fs => {
      const pos = fs.dataset.pos;
      calculatesum(pos);
    });
    updatetotals();
  }

  // sums
  function updatefields(position) {
    calculatesum(position);
    updatetotals();
  }

  function updatetotals() {
    let netsum = 0;
    let totalsum = 0;
    const taxsums = {};
    const fieldsets = document.querySelectorAll('fieldset.invoicepos');

    for (const fieldset of fieldsets) {
      const pos = fieldset.dataset.pos;
      const taxInput = document.getElementById('steuersatz' + pos);
      const totalInput = document.getElementById('total' + pos);
      if (!taxInput || !totalInput) continue;
      const taxamount = Number((taxInput.value || '0').toString().replace(',', '.'));
      const linetotal = Number((totalInput.value || '0').toString().replace(',', '.'));
      const tax = linetotal * taxamount / 100;
      const gross = tax + linetotal;
      taxsums[taxamount] = (taxsums[taxamount] || 0) + tax;
      netsum += linetotal;
      totalsum += gross;
    }

    const netsumElement = document.getElementById("netsum");
    const totalsumElement = document.getElementById("gross");
    netsumElement.innerText = (Math.round(netsum * 100) / 100).toFixed(2);
    totalsumElement.innerText = (Math.round(totalsum * 100) / 100).toFixed(2);

    // tax rows
    const keys = Object.keys(taxsums).sort((a, b) => b - a);
    document.querySelectorAll('.taxrow').forEach(e => e.remove());
    for (let i = 0; i < keys.length; i++) {
      const k = keys[i];
      const value = taxsums[k];
      if (value > 0) {
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        td1.innerText = "Umsatzsteuer " + k + "%";
        td2.innerText = (Math.round(value * 100) / 100).toFixed(2);
        td2.setAttribute("class", "text-end");
        const tr = document.createElement("tr");
        tr.setAttribute("class", "taxrow");
        tr.appendChild(td1);
        tr.appendChild(td2);
        const netsumrow = document.getElementById("netsumrow");
        netsumrow.insertAdjacentElement("afterend", tr);
      }
    }
  }

  function calculatesum(position) {
    const epElt = document.getElementById("einzelpreis" + position);
    const qtyElt = document.getElementById("menge" + position);
    const totalElt = document.getElementById("total" + position);
    if (!epElt || !qtyElt || !totalElt) return;

    let ep = epElt.value;
    let qty = qtyElt.value;

    if (ep !== '' && qty !== '') {
      ep = ep.replace(',', '.');
      qty = qty.replace(',', '.');
      const total = Number(ep) * Number(qty);
      totalElt.value = isNaN(total) ? '' : (Math.round(total * 100) / 100).toFixed(2);
    } else {
      totalElt.value = '';
    }
  }

  // init: sums + sortable
  document.addEventListener("DOMContentLoaded", function () {
    updatetotals();
    if (window.Sortable) {
      Sortable.create(document.getElementById('positions'), {
        animation: 150,
        draggable: 'fieldset.invoicepos',
        handle: '.drag-handle',
        onEnd: renumberPositions
      });
    }
  });
</script>
<script>
  // --- Utilities -------------------------------------------------------------

  // helper function: get CSRF token from hidden input
  function getCSRFToken() {
    const el = document.querySelector('input[name="csrf"]');
    return el?.value || '';
  }

  // Server API: send CSV/XML to the server and get JSON (our schema) back
  async function serverImportPositions(file) {
    const fd = new FormData();
    fd.append('file', file, file.name);
    // CSRF: send both header and form field, depending on middleware
    const csrf = getCSRFToken();
    fd.append('csrf', csrf);

    const res = await fetch('/invoice/import-positions', {
      method: 'POST',
      headers: { 'X-CSRF-Token': csrf },
      body: fd,
      credentials: 'same-origin',
    });
    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error(`Server-Import fehlgeschlagen (${res.status}): ${text || 'Unbekannter Fehler'}`);
    }
    // expected: { version: 1, positions: [...] }
    return res.json();
  }


  function removeAllPositions() {
    const container = document.getElementById('positions');
    container.querySelectorAll('fieldset.invoicepos').forEach(fs => fs.remove());
    // numbering consistent after clearing (now 0 rows)
    renumberPositions();
    updatetotals();
  }

  function normalizeNumber(v) {
    if (v === null || v === undefined) return NaN;
    if (typeof v === 'number') return v;
    if (typeof v === 'string') {
      const s = v.trim().replace(/\u00A0/g, ' ').replace(',', '.');
      if (s === '') return NaN;
      return Number(s);
    }
    return NaN;
  }

  function setValueById(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = val;
  }

  function showImportError(msg) {
    const box = document.getElementById('import-errors');
    if (box) box.textContent = msg;
  }

  function clearImportError() { showImportError(''); }

  // add a new empty position row and wait until it's in the DOM
  function addEmptyPositionRow() {
    return new Promise((resolve) => {
      const container = document.getElementById('positions');
      const beforeCount = container.querySelectorAll('fieldset.invoicepos').length;

      const obs = new MutationObserver(() => {
        const all = container.querySelectorAll('fieldset.invoicepos');
        if (all.length > beforeCount) {
          // Find the fieldset with the highest dataset.pos (the freshly added one)
          let maxPos = -1;
          all.forEach(fs => {
            const n = Number(fs.dataset.pos);
            if (Number.isFinite(n) && n > maxPos) maxPos = n;
          });
          obs.disconnect();
          resolve(maxPos);
        }
      });

      obs.observe(container, { childList: true, subtree: true });

      // Trigger Alpine to add a new row
      const btn = document.querySelector('#addposition button[type="button"]');
      btn?.click();
    });
  }

  function fillPosition(pos, { unit, quantity, net_price, tax_rate, text }) {
    // Fallbacks
    const defaultTax = Number(document.getElementById('defaultTaxRate')?.value || 0);
    const u = unit || 'C62';
    const qty = normalizeNumber(quantity);
    const price = normalizeNumber(net_price);
    const tax = Number.isNaN(normalizeNumber(tax_rate)) ? defaultTax : normalizeNumber(tax_rate);

    setValueById(`einheit${pos}`, u);
    if (!Number.isNaN(qty)) setValueById(`menge${pos}`, String(qty).replace('.', ','));
    if (!Number.isNaN(price)) setValueById(`einzelpreis${pos}`, String(price).replace('.', ','));
    if (!Number.isNaN(tax)) setValueById(`steuersatz${pos}`, String(tax).replace('.', ','));
    setValueById(`text${pos}`, text || '');

    // Recalculate line total
    calculatesum(pos);
  }

  function parsePositionsFromJSON(text) {
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      throw new Error('Ungültiges JSON.');
    }
    if (!data || typeof data !== 'object' || !Array.isArray(data.positions)) {
      throw new Error('JSON hat kein "positions"-Array.');
    }
    // Lightweight validation
    const out = [];
    data.positions.forEach((p, i) => {
      if (!p || typeof p !== 'object') throw new Error(`positions[${i}] ist ungültig.`);
      if (!('text' in p)) throw new Error(`positions[${i}]: "text" fehlt.`);
      if (!('quantity' in p)) throw new Error(`positions[${i}]: "quantity" fehlt.`);
      if (!('net_price' in p)) throw new Error(`positions[${i}]: "net_price" fehlt.`);
      out.push({
        text: String(p.text),
        quantity: p.quantity,
        net_price: p.net_price,
        tax_rate: p.tax_rate,
        unit: p.unit
      });
    });
    return out;
  }

  // file import end-to-end: JSON local, CSV/XML via server -> JSON
  async function handleImportFile(file) {
    clearImportError();
    if (!file) return;

    const ext = (file.name.split('.').pop() || '').toLowerCase();

    try {
      // 1) Parse JSON directly in the browser
      let payload;
      if (ext === 'json') {
        const text = await file.text();
        payload = parsePositionsFromJSON(text); // -> Array of rows (text, quantity, net_price, tax_rate?, unit?)
        // Wrap into our unified object
        payload = { version: 1, positions: payload };
      } else if (ext === 'csv' || ext === 'xml') {
        // 2) Send CSV/XML to the server -> server returns JSON format
        payload = await serverImportPositions(file); // -> {version:1, positions:[...]}
      } else {
        throw new Error('Nur .json, .csv oder .xml werden unterstützt.');
      }

      if (!payload || !Array.isArray(payload.positions)) {
        throw new Error('Antwort hat kein "positions"-Array.');
      }

      // 3) Replace mode: clear existing rows, then recreate them
      removeAllPositions();

      // 4) Create and populate rows sequentially (mutation observer variant)
      for (const r of payload.positions) {
        const pos = await addEmptyPositionRow(); // waits until the fieldset is in the DOM
        fillPosition(pos, r);
      }
      renumberPositions();
      updatetotals();

    } catch (e) {
      showImportError(e.message || String(e));
    }
  }


  // File-Input listener
  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('import-file');
    if (fileInput) {
      fileInput.addEventListener('change', (ev) => {
        const f = ev.target.files?.[0];
        handleImportFile(f);
        ev.target.value = '';
      });
    }
  });
</script>


{{ template "footer.html" . }}