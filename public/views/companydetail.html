{{template "header.html" .}}
{{with .companydetail}}
<div class="mb-8" id="main-content">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">{{.Name}}</h2>

  {{ with .Background}}
  <div class="bg-gray-50 rounded-lg p-4 mb-2">
    <p>{{.}}</p>
  </div>
  {{end}}

  <div class="bg-gray-50 rounded-lg p-4">
    <p>{{.Adresse1}}{{with .Adresse2}}<br>{{.}}{{end}}
      <br>{{.PLZ}} {{.Ort}}<br>
      {{.Land}}
    </p>
  </div>

  <div class="bg-gray-50 rounded-lg p-4 mt-4">
    <p>E-Mail für Rechnungen: <a href="mailto:{{.RechnungEmail}}">{{.RechnungEmail}}</a><br>
      USt-IdNr: {{.VATID}}</p>

    <div class="mt-4">
      <i>Rufnummern:</i>
      {{ range .Phones}}
      <p>{{.Location}}: {{ .Number}}</p>
      {{end}}
    </div>

    <div class="mt-4">
      <i>Kontakte:</i>
      {{ range .Contacts}}
      <p><a href="/person/{{.ID}}">{{.Name}}</a></p>
      {{end}}
    </div>
  </div>
</div>

<!-- Toolbar + Formular teilen sich denselben Alpine-Scope -->
<div x-data="{
       openInvoices: false,
       noteOpen: new URLSearchParams(window.location.search).get('addNote') === '1'
     }">

  <!-- Button-Leiste -->
  <div class="flex flex-wrap items-center gap-2 mb-4">
    <!-- Bearbeiten -->
    <a href="/company/edit/{{.ID}}"
       class="inline-block bg-primary text-text px-6 py-3 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
      <i class="fas fa-edit"></i> Bearbeiten
    </a>

    <!-- Rechnungen (Dropdown) -->
    {{ with $.companydetail.Invoices}}
    <div class="relative inline-block text-left">
      <button @click="openInvoices = !openInvoices"
              class="px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
        Rechnungen
      </button>
      <div x-show="openInvoices" x-cloak @click.away="openInvoices = false"
           class="absolute z-10 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 overflow-hidden">
        {{ range . }}
        <a href="/invoice/detail/{{.ID}}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">{{.Number}}</a>
        {{ end }}
      </div>
    </div>
    {{ end }}

    <!-- Neue Rechnung -->
    <a href="/invoice/new/{{.ID}}"
       class="inline-block px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
      <i class="fas fa-plus-circle"></i> Neue Rechnung
    </a>

    <!-- Neuer Kontakt -->
    <a href="/person/new/{{.ID}}"
       class="inline-block px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
      <i class="fas fa-plus-circle"></i> Neuer Kontakt
    </a>

    <!-- Neue Notiz -->
    <button
      @click.prevent="noteOpen = !noteOpen; if(noteOpen) $nextTick(() => $refs.noteTitle?.focus())"
      class="inline-block px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
      <i class="fas fa-sticky-note"></i> Neue Notiz
    </button>

    <!-- Fallback ohne JS -->
    <noscript>
      <a href="/note/new/{{.ID}}" class="inline-block px-4 py-2 bg-white border rounded-button shadow">
        Neue Notiz
      </a>
    </noscript>
  </div>

  <!-- Ausklapp-Formular: Neue Notiz -->
  <div x-show="noteOpen" x-transition x-cloak
       class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
    {{ with $.flash_note_error }}
      <div class="mb-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md p-2">{{.}}</div>
    {{ end }}

    <form method="POST" action="/notes/create" class="space-y-3">
      {{ with $.CSRFToken }}<input type="hidden" name="csrf" value="{{.}}">{{ end }}
      <input type="hidden" name="parent_id" value="{{.ID}}">
      <input type="hidden" name="parent_type" value="companies">

      <div>
        <label for="note_title" class="block text-sm font-medium text-gray-700">Titel</label>
        <input x-ref="noteTitle" id="note_title" name="title" type="text"
               class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
      </div>

      <div>
        <label for="note_body" class="block text-sm font-medium text-gray-700">Notiz</label>
        <textarea id="note_body" name="body" rows="4" required
                  class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
      </div>

      <div class="flex items-center gap-4">
        <input type="text" name="tags" placeholder="Tags, komma-getrennt"
               class="flex-1 border rounded-md px-3 py-2">
      </div>

      <div class="flex gap-2">
        <button type="submit"
                class="bg-primary text-text px-5 py-2 rounded-button font-bold hover:bg-hover hover:text-white transition-colors">
          Speichern
        </button>
        <button type="button" @click="noteOpen=false"
                class="px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50">
          Abbrechen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Notizen-Liste -->
{{ with $.notes }}
<div class="bg-white border border-gray-200 rounded-lg divide-y">
  {{ range . }}
  <div class="p-4 relative group" x-data="{ edit: false }">
    {{ $isAuthor := eq $.uid .AuthorID }}

    <!-- Edit-Button nur für Autor -->
    {{ if $isAuthor }}
      <!-- Desktop: auf Hover einblenden -->
      <button
        x-show="!edit"
        @click="edit = true"
        class="hidden sm:inline-flex items-center gap-1 absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-xs px-2 py-1 border rounded-md bg-white hover:bg-gray-50 shadow">
        <i class="fas fa-pen"></i> Bearbeiten
      </button>
      <!-- Mobile: immer sichtbar -->
      <button
        x-show="!edit"
        @click="edit = true"
        class="sm:hidden absolute top-2 right-2 text-xs px-2 py-1 border rounded-md bg-white shadow">
        ✎
      </button>
    {{ end }}

    <!-- Anzeige-Modus -->
    <div x-show="!edit">
      {{ if .Title }}
        <h3 class="font-semibold mb-1">{{ .Title }}</h3>
      {{ else }}
        <h3 class="font-semibold text-gray-700 mb-1">Notiz</h3>
      {{ end }}

      <p class="text-xs text-gray-500 mb-2">
        {{- $t := .EditedAt -}}
        {{- if $t.IsZero -}}
          Aktualisiert: {{ fmtTime .UpdatedAt }}
        {{- else -}}
          Bearbeitet: {{ fmtTime .EditedAt }}
        {{- end -}}
      </p>

      <div class="text-sm text-gray-800">
        {{ nl2br .Body }}
      </div>

      {{ if .Tags }}
      <div class="mt-3 flex flex-wrap gap-2">
        {{ range (splitCSV .Tags) }}
          <span class="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">{{ . }}</span>
        {{ end }}
      </div>
      {{ end }}
    </div>

    <!-- Edit-Modus (Inline-Formular) -->
    {{ if $isAuthor }}
    <div x-show="edit" x-cloak class="mt-2">
      <form method="POST" action="/notes/update/{{ .ID }}" class="space-y-2 bg-gray-50 border rounded-lg p-3">
        {{ with $.CSRFToken }}<input type="hidden" name="csrf" value="{{.}}">{{ end }}

        <div>
          <label class="block text-xs font-medium text-gray-700" for="title_{{ .ID }}">Titel</label>
          <input id="title_{{ .ID }}" name="title" type="text" value="{{ .Title }}"
                 class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-700" for="body_{{ .ID }}">Notiz</label>
          <textarea id="body_{{ .ID }}" name="body" rows="4"
                    class="mt-1 block w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">{{ .Body }}</textarea>
        </div>

        <div>
          <label class="block text-xs font-medium text-gray-700" for="tags_{{ .ID }}">Tags</label>
          <input id="tags_{{ .ID }}" name="tags" type="text" value="{{ .Tags }}"
                 class="mt-1 block w-full border rounded-md px-3 py-2">
        </div>

        <div class="flex gap-2">
          <button type="submit"
                  class="bg-primary text-text px-4 py-2 rounded-button font-bold hover:bg-hover hover:text-white transition-colors text-sm">
            Speichern
          </button>
          <button type="button" @click="edit=false"
                  class="px-4 py-2 bg-white border rounded-button shadow hover:bg-gray-50 text-sm">
            Abbrechen
          </button>
        </div>
      </form>
    </div>
    {{ end }}
  </div>
  {{ end }}
</div>
{{ end }}

{{ end }}
{{template "footer.html" .}}
